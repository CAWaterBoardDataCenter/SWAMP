---
title: "SWAMP Field Measure Verification"
author: "Marc Petta"
date: "January 2018"
output: xlsx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
### SWAMP Field Measurements and Physical Habitat Template Verification Automation
The SWAMP Field Measurements and Physical Habitat Template often requires modification upon reciept. For loading, ensure that the Funding Code worksheet has been added (position sheet = 6) and has appropriate field names. As of November 2018 the current SWAMP Field Loader only accepts xls files; save file format accordingly for loading. 

##For using this script ensure the file read is saved as xlsx.

ASSUMPTIONS:
What follows assumes that xlsx formatting matches what is generated by the Extraction Tool; assumes all constituents are fixed as of November 2018 and that each analyte has only one unit of measurement; treats all project grouped data equally and consideration should be made whether to apply this to non SWAMP data.

All valid range determination research was verified by ranges observed in SWAMP histroic data; 2017 and before.

Please note that this verifies common Field Measurement data submitted to SWAMP. New constituents/anlaytes need to be added here when they develop. If the file read here has uncommon or new constituents (as of November 2018) they will need to be reviewed manually.

```{r}
##########  112718 Solved CalibrationDate compare. Codes clean #########

#install.packages("writexl")
#install.packages("dplyr")
#install.packages("readxl") #used for read_excel but java dependant
#install.packages("openxlsx") does not specify column type

library(dplyr)
library(stringr)
library(readxl)
library(writexl)

```

## SWAMP Physical Habitat Data Verification
Whats follows is an automoation of the SWAMP Field Measurement Verification method.

```{r}
#Save SWAMP Field Measurements and Physical Habitat Template (xlsx) to working directory

#Read in the file that is to be verified. Read specified sheet and set col types
swamp = read_excel("swamp.xlsx", 
                   sheet = "FieldResults",
                   col_types = c("text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "numeric", "numeric", "text", "text", "text", "text", "text", "text", "text", "text", "numeric", "numeric", "text", "text", "text", "text", "text", "text", "text"))

#Transform col types as date time 
mutate(swamp, SampleDate= as.Date(SampleDate, format= "%d.%m.%Y"))
mutate(swamp, CalibrationDate= as.Date(CalibrationDate, format= "%d.%m.%Y"))

#Create new numeric variables to calcualte difference for CalibrationDate checks 
#######  ASSUMES THAT SampleDate AND CalibrationDate OCCURED IN SAME CALENDAR YEAR  ##########
swamp$SDateCom <- as.numeric(str_extract(swamp$SampleDate, "[0-9]+[0-9]"))
swamp$CDateCom <- as.numeric(str_extract(swamp$CalibrationDate, "[0-9]+[0-9]"))
swamp$cal_dif <- as.numeric(swamp$SDateCom - swamp$CDateCom)

#Transform col type as time
mutate(swamp, CollectionTime= as.Date(CollectionTime, format= "%H:%M:%S"))

#Review to ensure the data frame has the appropriate headers and formatted correctly.
head(swamp)
```


```{r}
########################## VERIFICATION ###############################
swamp1 <-
  swamp %>%
  mutate(ComplianceCode = case_when( 
    AnalyteName == "Alkalinity as CaCO3" & Result < 0 ~ "QAORR",
    AnalyteName == "Alkalinity as CaCO3" & Result > 500 ~ "QAORR",
    AnalyteName == "Chlorophyll a" & Result < 0 ~ "QAORR",
    AnalyteName == "Chlorophyll a" & Result > 15 ~ "QAORR",
    AnalyteName == "Discharge" & Result < 0 ~ "QAORR",
    AnalyteName == "Discharge" & Result > 1000 ~ "QAORR",
    AnalyteName == "ElectricalConductivity" & Result < 0 ~ "QAORR",
    AnalyteName == "ElectricalConductivity" & Result > 2000 ~ "QAORR",
    AnalyteName == "Oxygen, Saturation" & Result < 0 ~ "QAORR",
    AnalyteName == "Oxygen, Saturation" & Result > 175 ~ "QAORR",
    AnalyteName == "Oxygen, Dissolved" & Result < 0 ~ "QAORR",
    AnalyteName == "Oxygen, Dissolved" & Result > 20 ~ "QAORR",
    AnalyteName == "pH" & Result < 4 ~ "QAORR",
    AnalyteName == "pH" & Result > 8 ~ "QAORR",
    AnalyteName == "Salinity" & Result < 0 ~ "QAORR",
    AnalyteName == "Salinity" & Result > 34 ~ "QAORR",
    AnalyteName == "Silica as SiO2" & Result < 0 ~ "QAORR",
    AnalyteName == "Silica as SiO2" & Result > 100 ~ "QAORR",
    AnalyteName == "SpecificConductivity" & Result < 0 ~ "QAORR",
    AnalyteName == "SpecificConductivity" & Result > 2000 ~ "QAORR",
    AnalyteName == "Temperature" & MatrixName == "air" & Result < -10 ~ "QAORR",
    AnalyteName == "Temperature" & MatrixName == "air" & Result > 45 ~ "QAORR",
    AnalyteName == "Temperature" & MatrixName == "samplewater" & Result < 0 ~ "QAORR",
    AnalyteName == "Temperature" & MatrixName == "samplewater" & Result > 25 ~ "QAORR",
    AnalyteName == "Turbidity" & Result < -5 ~ "QAORR",
    AnalyteName == "Turbidity" & Result > 350 ~ "QAORR",
    AnalyteName == "Velocity" & Result < -10 ~ "QAORR",
    AnalyteName == "Velocity" & Result > 75 ~ "QAORR",
    AnalyteName == "Oxygen, Dissolved" & cal_dif > 1 ~ "QAORR",
    AnalyteName == "Oxygen, Dissolved" & cal_dif < 0 ~ "QAORR",
    TRUE ~ "Com"
  ))
#apply QACode for FCL
swamp1 <-
  swamp1 %>%
  mutate(QACode = as.factor(ifelse(AnalyteName == "Oxygen, Dissolved" & cal_dif > 1, "FCL", QACode )))

########################################  QA Code Verification  #####################################

  #looks at QACode and returns QAORR if value other than None
  #looks at BatchVerificationCode
  #looks at ResQualCode

swamp1 <-
  swamp1 %>%
  mutate(ComplianceCode = as.factor(ifelse(QACode == "None", ComplianceCode, "QAORR"))) %>%
  mutate(BatchVerificationCode = as.factor(ifelse(ComplianceCode == "Com", "VAC", "NA" ))) %>%
  mutate(ResQualCode = as.character(ifelse(Result == "", "NR", ResQualCode)))

View(swamp1)
```

The output of the following is to be reviewed and imported into the final template for loading.
The result of this will require that all ComplianceCodes, ResQualCodes, and QACodes are finalized according to SWAMP business rules before loading.

```{r}
#removes col calibration date calculation ###THIS IS NOT WORKING COLS REMAIN 121318

swamp1[ , -which(names(swamp1) %in% c("SDateCom","CDateCom", "cal_dif"))]

write_xlsx(swamp1, "SWAMP_WrtiteTest.xlsx", col_names = TRUE)

```
